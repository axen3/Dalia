<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n="page_title">Product – SoleStreet</title>
<link rel="prefetch" href="/header.html" as="fetch" crossorigin="anonymous">
<link rel="prefetch" href="/footer.html" as="fetch" crossorigin="anonymous">
  <!-- GOOGLE FONTS -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+Arabic:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="styles.css">

  <style>
    /* ARABIC FONT – TEXT ONLY */
    html[lang="ar"] {
      font-family: 'Noto Sans Arabic', 'Inter', sans-serif !important;
      line-height: 1.8;
    }

    /* PROTECT FONT AWESOME ICONS */
    html[lang="ar"] i[class^="fa"],
    html[lang="ar"] i[class*=" fa-"] {
      font-family: "Font Awesome 6 Free", "Font Awesome 6 Brands" !important;
      font-weight: 900 !important;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    html[lang="ar"] i {
      font-style: normal !important;
    }

    /* RTL: VALUE LEFT, LABEL RIGHT */
    [dir="rtl"] .breakdown-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      font-size: 1rem;
    }
    [dir="rtl"] .breakdown-line span:first-child { order: 2; text-align: right; }
    [dir="rtl"] .breakdown-line span:last-child { order: 1; text-align: left; font-weight: 600; }
    [dir="rtl"] .breakdown-line.total {
      font-weight: 700;
      font-size: 1.1rem;
      border-top: 1px solid #e2e8f0;
      padding-top: 0.75rem;
      margin-top: 0.5rem;
    }

    /* RTL: QUANTITY – LABEL RIGHT, BUTTONS LEFT */
    [dir="rtl"] .quantity {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      justify-content: flex-start;
      flex-direction: row-reverse;
    }
    [dir="rtl"] .quantity strong { order: 2; margin-right: auto; }
    [dir="rtl"] .quantity .quantity-controls { order: 1; display: flex; gap: 0.5rem; }
    .quantity-controls { display: flex; gap: 0.5rem; }

    /* FORM VALIDATION STYLES */
    .form-group { position: relative; margin-bottom: 0.5rem; transition: margin-bottom 0.2s ease; }
    .form-group.has-error { margin-bottom: 1.5rem; }
    .error-msg, .option-error { color: #dc2626; font-size: 0.8rem; margin-top: 0.25rem; display: block; opacity: 0; height: 0; overflow: hidden; transition: opacity 0.2s ease, height 0.2s ease; }
    .error-msg.show, .option-error.show { opacity: 1; height: auto; }
    .form-group input, .form-group textarea { width: 100%; padding: 0.75rem; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 1rem; transition: border-color 0.2s; }
    .form-group input:focus, .form-group textarea:focus { outline: none; border-color: #2563eb; }
    .form-group.error input, .form-group.error textarea { border-color: #dc2626 !important; }
    .form-note { text-align: center; color: #64748b; margin-top: 1rem; font-size: 0.9rem; }
    .submit-feedback { text-align: center; margin-top: 0.75rem; font-size: 0.9rem; min-height: 1.2rem; opacity: 0; transition: opacity 0.2s; }
    .submit-feedback.show { opacity: 1; }
    .submit-feedback.success { color: #16a34a; }
    .submit-feedback.error { color: #dc2626; }
    .hidden { display: none !important; }

    .success-screen { display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 3rem 1.5rem; background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%); border: 1px solid #86efac; border-radius: 16px; margin: 2rem 0; animation: fadeIn 0.6s ease-out; }
    .success-screen.show { display: flex; }
    .success-icon { width: 80px; height: 80px; background: #16a34a; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; margin-bottom: 1.5rem; animation: bounceIn 0.8s ease-out; }
    .success-title { font-size: 1.8rem; font-weight: 700; color: #166534; margin-bottom: 0.75rem; }
    .success-text { font-size: 1rem; color: #166534; margin-bottom: 1.5rem; max-width: 400px; }
    .back-to-shop { background: #16a34a; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; text-decoration: none; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem; }
    .back-to-shop:hover { background: #15803d; transform: translateY(-2px); }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes bounceIn { 0% { transform: scale(0.3); opacity: 0; } 50% { transform: scale(1.1); } 70% { transform: scale(0.9); } 100% { transform: scale(1); opacity: 1; } }

    .rating { display: flex; align-items: center; gap: 0.5rem; margin: 0.75rem 0; font-size: 0.95rem; color: #1e293b; }
    .stars { color: #f59e0b; font-size: 1.1rem; }
    .stars .fa-star-half-stroke { color: #fbbf24; }
    .review-count { color: #64748b; font-size: 0.9rem; }

    .long-description { margin-top: 2.5rem; line-height: 1.7; }
    .long-description h1 { font-size: 1.9rem; margin: 1.5rem 0 .75rem; color: #1e293b; }
    .long-description h2 { font-size: 1.6rem; margin: 1.25rem 0 .5rem; color: #1e293b; }
    .long-description p { margin-bottom: .75rem; }
    .long-description img { max-width: 100%; height: auto; border-radius: 12px; margin: 1.5rem 0; box-shadow: 0 4px 12px rgba(0,0,0,.1); }
    .long-description ul, .long-description ol { margin: 1rem 0; padding-left: 1.5rem; }
    .long-description li { margin-bottom: .4rem; }
  </style>
</head>
<body>

  <div id="header"></div>

  <section class="product-wrapper" id="mainContent">
    <div class="gallery">
      <img id="mainImg" class="main-img" src="" alt="Main product" loading="lazy">
      <div class="thumbs" id="thumbs"></div>
    </div>

    <div class="details">
      <div class="brand" id="brand"></div>
      <h1 class="product-detail-name" id="name"></h1>

      <div class="rating" id="ratingContainer"></div>

      <div class="pricing">
        <span class="current" id="current"></span>
        <span class="original" id="original"></span>
        <span class="discount-badge" id="discount"></span>
      </div>

      <div class="shipping-info" id="shippingInfo"></div>
      <p class="description" id="shortDescription"></p>

      <div class="colors" id="colorSwatches" style="display:none;">
        <strong data-i18n="select_color">اختر اللون:</strong><br>
        <div id="colorError" class="option-error"></div>
      </div>

      <div class="sizes" id="sizeContainer" style="display:none;">
        <strong data-i18n="select_size">اختر المقاس:</strong><br>
        <div id="sizeError" class="option-error"></div>
      </div>

      <div class="quantity" id="quantityContainer">
        <strong data-i18n="quantity">الكمية:</strong>
        <div class="quantity-controls">
          <button type="button" id="decreaseQty">−</button>
          <input type="number" id="quantityInput" value="1" min="1" max="10" readonly>
          <button type="button" id="increaseQty">+</button>
        </div>
      </div>

      <div id="orderFormContainer">
        <form id="orderForm" class="order-form" novalidate>
          <div class="form-group" id="groupFullName">
            <input type="text" id="fullName" data-i18n-placeholder="full_name" placeholder="الاسم الكامل">
            <span class="error-msg" id="errorFullName"></span>
          </div>
          <div class="form-group" id="groupAddress">
            <textarea id="address" rows="3" data-i18n-placeholder="address" placeholder="العنوان"></textarea>
            <span class="error-msg" id="errorAddress"></span>
          </div>
          <div class="form-group" id="groupCity">
            <input type="text" id="city" data-i18n-placeholder="city" placeholder="المدينة">
            <span class="error-msg" id="errorCity"></span>
          </div>
          <div class="form-group" id="groupPhone">
            <input type="tel" id="phone" data-i18n-placeholder="phone" placeholder="رقم الهاتف (10 أرقام)">
            <span class="error-msg" id="errorPhone"></span>
          </div>

          <div class="price-breakdown">
            <div class="breakdown-line">
              <span data-i18n="product_price">سعر المنتج:</span>
              <span id="breakdownPrice"></span>
            </div>
            <div class="breakdown-line">
              <span data-i18n="shipping">التوصيل:</span>
              <span id="breakdownShipping"></span>
            </div>
            <div class="breakdown-line total">
              <span data-i18n="total">الإجمالي:</span>
              <span id="breakdownTotal"></span>
            </div>
          </div>

          <div class="order-buttons">
            <button type="submit" class="add-cart-btn" data-i18n="place_order">تأكيد الطلب (حفظ في الجدول)</button>
            <a href="#" id="whatsappOrderBtn" class="whatsapp-order-btn">
              <i class="fab fa-whatsapp"></i> <span data-i18n="whatsapp_order">طلب عبر واتساب</span>
            </a>
          </div>

          <div class="submit-feedback" id="submitFeedback"></div>
        </form>

        <p class="form-note"><small data-i18n="choose_method">اختر طريقة الطلب.</small></p>
      </div>

      <div class="success-screen" id="successScreen">
        <div class="success-icon"><i class="fas fa-check"></i></div>
        <div class="success-title" data-i18n="order_saved">تم حفظ الطلب!</div>
        <div class="success-text" data-i18n="order_saved_text">تم حفظ طلبك. سنتواصل معك قريباً.</div>
        <a href="index.html" class="back-to-shop" data-i18n="back_to_shop">العودة إلى المتجر</a>
      </div>

      <div class="long-description" id="longDescription"></div>
    </div>
  </section>

  <div id="footer"></div>

  <script>
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycby8h3Q91EeE4kgt7IxaGmT1-y0jp46zVY-5Kd6BbGNgA1v2r20HaXsxER9SdYk5N4gC/exec';
    const WHATSAPP_NUMBER = '212612345678';
    let currentProduct = null,
    currentShippingCost = 0, hasColors = false, hasSizes = false, currency = 'MAD';
    let lang = localStorage.getItem('lang') || (navigator.language.includes('fr') ? 'fr' : 'ar');
    let translations = {};

    async function loadLang() {
      const res = await fetch(`lang/${lang}.json?v=${Date.now()}`);
      translations = await res.json();
      document.documentElement.lang = lang;
      document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
      updatePriceBreakdown();
      applyTranslations();
      updateLangButtons();
      updateShippingInfo();
      if (currentProduct) {
        
        updatePriceBreakdown();
        updateShippingInfo();
      }
    }

    function applyTranslations() {
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (translations[key]) el.innerHTML = translations[key];
      });
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        if (translations[key]) el.placeholder = translations[key];
      });
      const reviewCount = document.querySelector('.review-count');
      if (reviewCount) {
        const num = reviewCount.textContent.match(/\d+/)?.[0] || '127';
        reviewCount.innerHTML = `(${num} ${t('reviews')})`;
      }
    }

    function updateLangButtons() {
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
      });
    }

    document.addEventListener('click', (e) => {
      if (e.target.matches('.lang-btn')) {
        lang = e.target.dataset.lang;
        localStorage.setItem('lang', lang);
        loadLang();
      }
    });

    function t(key) {
      return translations[key] || key;
    }

    function updatePriceBreakdown() {
      if (!currentProduct || !document.getElementById('quantityInput')) return;
      const qty = parseInt(document.getElementById('quantityInput').value) || 1;
      const productPrice = currentProduct.price * qty;
      const shippingCost = currentProduct.shipping === 'free' ? 0 : currentShippingCost * qty;
      const total = productPrice + shippingCost;
      currency = lang === 'ar' ? ' د.م' : ' MAD';

      document.getElementById('breakdownPrice').textContent = `${productPrice.toFixed(2)}${currency}`;
      document.getElementById('breakdownShipping').textContent = currentProduct.shipping === 'free' 
        ? t('free_shipping')
        : `${shippingCost.toFixed(2)}${currency}`;
      document.getElementById('breakdownTotal').textContent = `${total.toFixed(2)}${currency}`;
    }

    function updateShippingInfo() {
      const shippingEl = document.getElementById('shippingInfo');
      if (!shippingEl || !currentProduct) return;
      if (currentProduct.shipping === 'free') {
        shippingEl.innerHTML = `<i class="fas fa-truck"></i> ${t('free_shipping')}`;
        shippingEl.style.color = '#16a34a';
      } else if (currentProduct.shipping?.cost) {
        shippingEl.innerHTML = `<i class="fas fa-truck"></i> ${currentProduct.shipping.cost.toFixed(2)} ${currency}`;
        shippingEl.style.color = '#dc2626';
      }
    }

    async function loadProducts() { 
      const res = await fetch('products.json?v=20251111'); 
      if (!res.ok) throw new Error('Failed'); 
      return await res.json(); 
    }

    async function init() {
      const urlParams = new URLSearchParams(window.location.search);
      const id = parseInt(urlParams.get('id'), 10);
      if (!id || isNaN(id)) { document.body.classList.add('hidden'); return; }
      try {
        const products = await loadProducts();
        const product = products.find(p => p.id === id);
        if (!product) { document.body.classList.add('hidden'); return; }
        renderProduct(product);
      } catch (err) { console.error(err); document.body.classList.add('hidden'); }
    }

    function renderProduct(p) {
      currentProduct = p; 
      currentShippingCost = (p.shipping === 'free' ? 0 : (p.shipping?.cost || 0));
      
      document.getElementById('brand').textContent = p.brand;
      document.getElementById('name').textContent = p.name;
      document.getElementById('current').textContent = `${p.price.toFixed(2)} ${currency}`;
      document.getElementById('shortDescription').textContent = p.shortDescription || '';

      const ratingContainer = document.getElementById('ratingContainer');
      const rating = p.rating || 4.8; const reviews = p.reviews || 127;
      const fullStars = Math.floor(rating); const hasHalf = rating % 1 >= 0.5;
      let starsHTML = '';
      for (let i = 0; i < fullStars; i++) starsHTML += '<i class="fas fa-star"></i>';
      if (hasHalf) starsHTML += '<i class="fas fa-star-half-stroke"></i>';
      for (let i = fullStars + (hasHalf ? 1 : 0); i < 5; i++) starsHTML += '<i class="far fa-star"></i>';
      ratingContainer.innerHTML = `<div class="stars">${starsHTML}</div><span><strong>${rating.toFixed(1)}</strong> <span class="review-count">(${reviews} ${t('reviews')})</span></span>`;

      if (p.originalPrice) {
        const discount = Math.round(((p.originalPrice - p.price) / p.originalPrice) * 100);
        document.getElementById('original').textContent = `${p.originalPrice.toFixed(2)} ${currency}`;
        document.getElementById('discount').textContent = `-${discount}%`;
      } else { 
        document.getElementById('original').style.display = 'none'; 
        document.getElementById('discount').style.display = 'none'; 
      }

      updateShippingInfo();
      updatePriceBreakdown();

      const mainImg = document.getElementById('mainImg'); mainImg.src = p.images[0] || p.image;
      const thumbs = document.getElementById('thumbs'); thumbs.innerHTML = '';
      p.images.forEach((src, i) => {
        const img = document.createElement('img'); img.src = src; img.alt = `View ${i + 1}`; img.loading = 'lazy';
        if (i === 0) img.classList.add('active');
        img.onclick = () => { mainImg.src = src; thumbs.querySelectorAll('img').forEach(t => t.classList.remove('active')); img.classList.add('active'); };
        thumbs.appendChild(img);
      });

      const colorDiv = document.getElementById('colorSwatches');
      if (Array.isArray(p.colors) && p.colors.length > 0) {
        hasColors = true; colorDiv.style.display = 'block';
        const swatchContainer = document.createElement('div'); swatchContainer.style.marginTop = '0.5rem';
        p.colors.forEach((c, i) => {
          const btn = document.createElement('button'); btn.type = 'button'; btn.className = 'color-swatch'; btn.title = c.name;
          btn.style.backgroundColor = c.hex; btn.style.border = c.hex.toLowerCase() === '#ffffff' ? '2px solid #ddd' : '2px solid transparent';
          btn.style.width = btn.style.height = '38px'; btn.style.margin = '0 0.5rem 0.5rem 0'; btn.style.borderRadius = '50%'; btn.style.cursor = 'pointer';
          const check = document.createElement('i'); check.className = 'fas fa-check'; check.style.position = 'absolute'; check.style.top = '50%'; check.style.left = '50%';
          check.style.transform = 'translate(-50%,-50%)'; check.style.color = '#fff'; check.style.fontSize = '14px'; check.style.display = 'none'; btn.appendChild(check);
          btn.onclick = () => { colorDiv.querySelectorAll('.color-swatch').forEach(b => { b.classList.remove('active'); b.querySelector('i').style.display = 'none'; }); btn.classList.add('active'); btn.querySelector('i').style.display = 'block'; clearOptionError('colorError'); };
          if (i === 0) { btn.classList.add('active'); btn.querySelector('i').style.display = 'block'; }
          swatchContainer.appendChild(btn);
        });
        colorDiv.appendChild(swatchContainer);
      } else { hasColors = false; colorDiv.style.display = 'none'; }

      const sizeContainer = document.getElementById('sizeContainer');
      if (Array.isArray(p.sizes) && p.sizes.length > 0) {
        hasSizes = true; sizeContainer.style.display = 'block';
        const btnContainer = document.createElement('div'); btnContainer.style.marginTop = '0.5rem';
        p.sizes.forEach((s, i) => {
          const btn = document.createElement('button'); btn.type = 'button'; btn.textContent = s;
          btn.style.margin = '0 0.5rem 0.5rem 0';
          btn.onclick = () => { sizeContainer.querySelectorAll('button').forEach(b => b.classList.remove('active')); btn.classList.add('active'); clearOptionError('sizeError'); };
          if (i === 0) btn.classList.add('active');
          btnContainer.appendChild(btn);
        });
        sizeContainer.appendChild(btnContainer);
      } else { hasSizes = false; sizeContainer.style.display = 'none'; }

      const qtyInput = document.getElementById('quantityInput');
      const decreaseBtn = document.getElementById('decreaseQty');
      const increaseBtn = document.getElementById('increaseQty');
      decreaseBtn.onclick = () => { if (parseInt(qtyInput.value) > 1) { qtyInput.value--; updatePriceBreakdown(); } };
      increaseBtn.onclick = () => { if (parseInt(qtyInput.value) < 10) { qtyInput.value++; updatePriceBreakdown(); } };
      updatePriceBreakdown();

      const longDescDiv = document.getElementById('longDescription'); longDescDiv.innerHTML = '';
      (p.descriptionBlocks || []).forEach(block => { 
        let el; 
        if (block.type === 'h1') { el = document.createElement('h1'); el.textContent = block.content; } 
        else if (block.type === 'h2') { el = document.createElement('h2'); el.textContent = block.content; } 
        else if (block.type === 'paragraph') { el = document.createElement('p'); el.textContent = block.content; } 
        else if (block.type === 'image') { el = document.createElement('img'); el.src = block.src; el.alt = block.alt || ''; el.loading = 'lazy'; } 
        else if (block.type === 'ul') { el = document.createElement('ul'); (block.items || []).forEach(item => { const li = document.createElement('li'); li.textContent = item; el.appendChild(li); }); } 
        else if (block.type === 'ol') { el = document.createElement('ol'); (block.items || []).forEach(item => { const li = document.createElement('li'); li.textContent = item; el.appendChild(li); }); } 
        if (el) longDescDiv.appendChild(el); 
      });
    }

    // FULL FORM VALIDATION RESTORED
    function showError(fieldId, msg) {
      const group = document.getElementById(`group${fieldId.charAt(0).toUpperCase() + fieldId.slice(1)}`);
      const errorEl = document.getElementById(`error${fieldId.charAt(0).toUpperCase() + fieldId.slice(1)}`);
      group.classList.add('error', 'has-error');
      errorEl.textContent = msg;
      errorEl.classList.add('show');
    }

    function showOptionError(id, msg) {
      const el = document.getElementById(id);
      el.textContent = msg;
      el.classList.add('show');
    }

    function clearOptionError(id) {
      const el = document.getElementById(id);
      el.classList.remove('show');
    }

    function clearFeedback() {
      document.querySelectorAll('.form-group').forEach(g => g.classList.remove('error', 'has-error'));
      document.querySelectorAll('.error-msg').forEach(e => e.classList.remove('show'));
      clearOptionError('colorError'); clearOptionError('sizeError');
      const feedback = document.getElementById('submitFeedback');
      feedback.classList.remove('show', 'success', 'error');
    }

    function showFeedback(msg, type) {
      const feedback = document.getElementById('submitFeedback');
      feedback.textContent = msg;
      feedback.className = `submit-feedback show ${type}`;
    }

    const form = document.getElementById('orderForm');
    const formContainer = document.getElementById('orderFormContainer');
    const successScreen = document.getElementById('successScreen');
    const whatsappBtn = document.getElementById('whatsappOrderBtn');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearFeedback();
      const validation = validateForm();
      if (!validation.valid) {
        showFeedback(validation.msg, 'error');
        return;
      }
      await submitToSheet(validation.data);
    });

    whatsappBtn.addEventListener('click', (e) => {
      e.preventDefault();
      clearFeedback();
      const validation = validateForm();
      if (!validation.valid) {
        showFeedback(validation.msg, 'error');
        return;
      }
      openWhatsApp(validation.data);
    });

    function validateForm() {
      clearFeedback();
      let hasError = false;

      if (hasColors) {
        const colorBtn = document.querySelector('.color-swatch.active');
        if (!colorBtn) {
          showOptionError('colorError', lang === 'ar' ? 'الرجاء اختيار اللون' : 'Veuillez choisir une couleur');
          hasError = true;
        }
      }

      if (hasSizes) {
        const sizeBtn = document.querySelector('#sizeContainer button.active');
        if (!sizeBtn) {
          showOptionError('sizeError', lang === 'ar' ? 'الرجاء اختيار المقاس' : 'Veuillez choisir une taille');
          hasError = true;
        }
      }

      const fullName = document.getElementById('fullName').value.trim();
      const address  = document.getElementById('address').value.trim();
      const city     = document.getElementById('city').value.trim();
      const phone    = document.getElementById('phone').value.trim();
      const quantity = document.getElementById('quantityInput').value;

      if (!fullName) { showError('fullName', lang === 'ar' ? 'الاسم الكامل مطلوب' : 'Nom complet requis'); hasError = true; }
      if (!address) { showError('address', lang === 'ar' ? 'العنوان مطلوب' : 'Adresse requise'); hasError = true; }
      if (!city) { showError('city', lang === 'ar' ? 'المدينة مطلوبة' : 'Ville requise'); hasError = true; }
      if (!phone) { showError('phone', lang === 'ar' ? 'رقم الهاتف مطلوب' : 'Numéro requis'); hasError = true; }
      else if (!/^\d{10}$/.test(phone)) { showError('phone', lang === 'ar' ? 'يجب أن يكون 10 أرقام (مثال: 0612345678)' : '10 chiffres requis (ex: 0612345678)'); hasError = true; }

      if (hasError) {
        return { valid: false, msg: lang === 'ar' ? 'الرجاء تصحيح الأخطاء أعلاه.' : 'Veuillez corriger les erreurs ci-dessus.' };
      }

      const p = currentProduct;
      const qty = parseInt(quantity);
      const productPrice = p.price * qty;
      const shippingCost = p.shipping === 'free' ? 0 : currentShippingCost * qty;
      const color = hasColors ? document.querySelector('.color-swatch.active').title : 'N/A';
      const size = hasSizes ? document.querySelector('#sizeContainer button.active').textContent : 'N/A';

      return { valid: true, data: { p, qty, productPrice, shippingCost, color, size } };
    }

    async function submitToSheet({ p, qty, productPrice, shippingCost, color, size }) {
      const formData = new FormData();
      formData.append("product_id", p.id);
      formData.append("product_name", p.name);
      formData.append("product_color", color);
      formData.append("product_size", size);
      formData.append("quantity", qty);
      formData.append("product_price", productPrice.toFixed(2));
      formData.append("shipping", p.shipping === 'free' ? 0 : shippingCost.toFixed(2));
      formData.append("full_name", document.getElementById('fullName').value.trim());
      formData.append("address", document.getElementById('address').value.trim());
      formData.append("city", document.getElementById('city').value.trim());
      formData.append("phone_number", document.getElementById('phone').value.trim());

      const btn = form.querySelector('.add-cart-btn');
      const oldText = btn.textContent;
      btn.disabled = true;
      btn.textContent = lang === 'ar' ? 'جاري الإرسال...' : 'Envoi...';

      try {
        const res = await fetch(WEB_APP_URL, { method: 'POST', body: formData });
        const raw = await res.text();
        let json = JSON.parse(raw);
        if (json.status === 'success') {
          showSuccess(t('order_saved'), t('order_saved_text'));
        } else {
          showFeedback('Error: ' + (json.message || 'Unknown'), 'error');
        }
      } catch (err) {
        showFeedback(lang === 'ar' ? 'فشل الاتصال. حاول مرة أخرى.' : 'Connexion échouée. Réessayez.', 'error');
      } finally {
        btn.textContent = oldText;
        btn.disabled = false;
      }
    }

    function openWhatsApp({ p, qty, productPrice, shippingCost, color, size }) {
      const isAr = lang === 'ar';
      const msg = encodeURIComponent(
        (isAr ? `*طلب جديد من SoleStreet.ma*\n\n` : `*Nouvelle commande de SoleStreet.ma*\n\n`) +
        `${isAr ? 'المنتج' : 'Produit'}: ${p.name}\n` +
        (hasColors ? `${isAr ? 'اللون' : 'Couleur'}: ${color}\n` : '') +
        (hasSizes ? `${isAr ? 'المقاس' : 'Taille'}: ${size}\n` : '') +
        `${isAr ? 'الكمية' : 'Quantité'}: ${qty}\n` +
        `${isAr ? 'سعر المنتج' : 'Prix produit'}: ${productPrice.toFixed(2)} درهم\n` +
        `${isAr ? 'التوصيل' : 'Livraison'}: ${p.shipping === 'free' ? t('free_shipping') : shippingCost.toFixed(2) + ' درهم'}\n` +
        `${isAr ? 'الإجمالي' : 'Total'}: ${(productPrice + shippingCost).toFixed(2)} درهم\n\n` +
        `${isAr ? 'العميل' : 'Client'}:\n` +
        `الاسم: ${document.getElementById('fullName').value.trim()}\n` +
        `العنوان: ${document.getElementById('address').value.trim()}\n` +
        `المدينة: ${document.getElementById('city').value.trim()}\n` +
        `رقم الهاتف: ${document.getElementById('phone').value.trim()}\n\n` +
        (isAr ? `شكراً لثقتكم!` : `Merci pour votre confiance !`)
      );
      showSuccess(t('opening_whatsapp'), t('whatsapp_text'), 'fab fa-whatsapp');
      setTimeout(() => { window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${msg}`, '_blank'); }, 800);
    }

    function showSuccess(title, text, icon = 'fas fa-check') {
      formContainer.style.display = 'none';
      successScreen.querySelector('.success-icon i').className = icon;
      successScreen.querySelector('.success-title').textContent = title;
      successScreen.querySelector('.success-text').textContent = text;
      successScreen.classList.add('show');
    }

    function loadIncludes() {
      fetch('header.html')
        .then(r => r.ok ? r.text() : '<header><nav class="main-nav"><a href="index.html" class="logo">Sole<span>Street</span></a><button class="menu-toggle" aria-label="Toggle menu" aria-expanded="false"><i class="fas fa-bars"></i></button><ul class="nav-links" id="navLinks"><li><a href="index.html">Home</a></li><li><a href="#">Men</a></li><li><a href="#">Women</a></li><li><a href="#">Sale</a></li><li><a href="#">Contact</a></li></ul><div class="lang-switcher"><button class="lang-btn" data-lang="ar">العربية</button><button class="lang-btn" data-lang="fr">Français</button></div></nav></header>')
        .then(html => {
          document.getElementById('header').innerHTML = html;
          updateLangButtons();
          setupMobileMenu();
        });

      fetch('footer.html')
        .then(r => r.ok ? r.text() : '<footer><p>© SoleStreet</p></footer>')
        .then(html => document.getElementById('footer').innerHTML = html);
    }

    function setupMobileMenu() {
      const toggle = document.querySelector('.menu-toggle');
      const nav = document.getElementById('navLinks');
      if (!toggle || !nav) return;
      toggle.addEventListener('click', () => {
        const isOpen = nav.classList.toggle('open');
        toggle.setAttribute('aria-expanded', isOpen);
        toggle.querySelector('i').className = isOpen ? 'fas fa-times' : 'fas fa-bars';
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadLang().then(() => {
        init();
        loadIncludes();
      });
    });
  </script>
</body>
</html>